<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- DO NOT EDIT: file automatically generated by ucampas from
     /Users/graemejenkinson/cheri-website/cam/tesla/workflow-b.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><meta content="text/css" http-equiv="Content-Style-Type" /><title>Workflow</title><link rel="stylesheet" type="text/css" media="all" href="https://www.cl.cam.ac.uk/style/layout.css" /><link rel="stylesheet" type="text/css" media="print" href="https://www.cl.cam.ac.uk/style/print.css" /><link href="https://www.cl.cam.ac.uk/style/blue.css" media="all" rel="stylesheet" type="text/css" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="tesla.css" rel="stylesheet" type="text/css" /><link href="freebsd.html" rel="Next" /><link href="." rel="Up" /></head><body class="two-col dept">
<div id="skip"> <a href="#skip-content" accesskey="2">Skip to content</a>&#160;|&#160;<a href="https://www.cam.ac.uk/site/accesskeys.html" accesskey="0">Access key help</a> </div><div id="header">
  <div id="branding"><a href="https://www.cam.ac.uk/" accesskey="1"><img src="https://www.cl.cam.ac.uk/images/identifier.svg" alt="University of Cambridge" class="ucam" /></a>
  </div>

    <div id="site-search">

    <form action="http://web-search.cam.ac.uk/query.html" method="get">
      <fieldset>
      <label for="search-term">Search</label>
      <input name="qt" type="text" id="search-term" accesskey="4" value="" />
      <input id="search-button" src="https://www.cl.cam.ac.uk/images/button-search.gif" value="Search" alt="Search" title="Search" type="image" />
      </fieldset>
    </form>

    </div>
</div>

<div id="dept-title">
<h1><a href="../"></a></h1></div>

<div id="container"> <a name="skip-content" id="skip-content"></a>
<ul id="nav-breadcrumb"></ul><ul id="nav-primary"><li><div><a href="../">CTSRD&#160;&#187;</a></div></li><li><div><a href="../news.html">Project news</a></div></li><li><div><a href="../beri/">Bluespec Extensible RISC Implementation (BERI)&#160;&#187;</a></div></li><li><div><a href="../../capsicum/">Capsicum&#160;&#8594;</a></div></li><li><div><a href="../cheri/">Capability Hardware Enhanced RISC Instructions (CHERI)&#160;&#187;</a></div></li><li><div><a href="../soaap/">Security-Oriented Analysis of Application Programs (SOAAP)&#160;&#187;</a></div></li><li><div><a href=".">Temporally Enhanced Security Logic Assertions (TESLA)&#160;&#187;</a></div><ul><li><div><a href="build.html">Getting started</a></div></li><li class="active"><div><a href="workflow.html">Workflow</a></div></li><li><div><a href="freebsd.html">Building FreeBSD</a></div></li><li><div><a href="programming.html">Assertions and automata</a></div></li><li><div><a href="demos.html">Demos</a></div></li><li><div><a href="api">API Documentation&#160;&#8594;</a></div></li></ul></li><li><div><a href="../smten.html">Enhancing the Satisfiability Modulo Theories Experience (Smten)</a></div></li><li><div><a href="../publications.html">Publications</a></div></li><li><div><a href="../data/">Open Data&#160;&#187;</a></div></li><li><div><a href="../posters-slides.html">Posters and slides</a></div></li><li><div><a href="../people.html">Project members</a></div></li><li><div><a href="../related.html">Related</a></div></li></ul><div id="content"><div id="sub-brand"><p class="section">TESLA</p></div><div id="content-primary">
<h1 class="title">Workflow</h1><p>
Once you have <a href="build.html">built TESLA</a>, you need to either
install it to your PATH or else set two environment variables:
</p>

<div class="console"><span class="blue">$</span> export PATH=<span class="green">$PATH</span>:/path/to/tesla/scripts
</div>

<p>
The TESLA workflow deviates from a more typical LLVM-based workflow in that
it adds two steps:
</p>

<ol>
	<li>
		<a href="#analysis">analysis</a> of all C sources,
		generating .tesla files, followed by
	</li>
	<li>
		<a href="#instrumentation">instrumentation</a> of LLVM IR,
		based on <em>all</em> .tesla files, generating instrumented IR.
	</li>
</ol>

<p>This overall workflow is pictured below:</p>

<div class="figure">
	<img src="images/workflow.png" alt="TESLA workflow" />
	<p class="caption">
	The TESLA workflow augments an LLVM-based C workflow.
	</p>
</div>

<p>
On this page, we apply this workflow to a simple example: two C files
<code>foo.c</code> and <code>bar.c</code> that are compiled into a binary:
</p>

<div class="figure">
	<img src="images/example-deps.png" alt="Example workflow" />
	<p class="caption">
	A simple example of a TESLA workflow.
	</p>
</div>


<a name="analysis"></a>
<h2>Analysis</h2>

<p>
In the analysis stage, TESLA is used to parse temporal assertions defined by
the programmer as described in
<a href="programming.html">Programming with TESLA</a>.
To analyse source files foo.c and bar.c that require
<code>CFLAGS="-Wno-error -D VERSION=42"</code>, the programmer
(or the build system) should run the following commands:
</p>

<div class="console"><span class="blue">$</span> tesla analyse foo.c -o foo.tesla -- -Wno-error -D VERSION=42
<span class="blue">$</span> tesla analyse bar.c -o bar.tesla -- -Wno-error -D VERSION=42
<span class="blue">$</span> tesla cat foo.tesla bar.tesla -o tesla.manifest   <span class="blue"># combine into single manifest</span>
</div>

<p>
The TESLA analyser needs to know the appropriate CFLAGS because it is running
a full Clang parser on the C code, and errors, warnings, condititional
compilation, etc. need to be consistent with those options used by Clang when
compiling the source into LLVM IR.
</p>


<a name="instrumentation"></a>
<h2>Instrumentation</h2>

<p>
The LLVM instrumenter modifies LLVM IR, adding hooks for events that are
named in a TESLA manifest.
If once again CFLAGS="-Wno-error -D VERSION=42", the TESLA instrumenter is
run as follows:
</p>

<div class="console"><span class="blue">$</span> clang <span class="green">$CFLAGS</span> foo.c -o foo.ll
<span class="blue">$</span> tesla instrument -tesla-manifest tesla.manifest foo.ll -o foo.instr.ll
<span class="blue">$</span> tesla instrument -tesla-manifest tesla.manifest bar.ll -o bar.instr.ll
</div>

<p>
Calls to instrumentation are inserted inline within LLVM basic blocks:
</p>

<code class="diff listing"><span class="preprocessor">@@ -108,7 +202,9 @@</span>
   %3 = bitcast i8* %2 to i32*, !dbg !62
   %4 = load i32* %3, align 4, !dbg !62
   %add = add nsw i32 %4, 1, !dbg !62
<span class="add">+  call void @__tesla_instrumentation_struct_field_store_struct.object.refcount(%struct.object* %0, i3</span>
2 %add, i32* %3), !dbg !62
   store i32 %add, i32* %3, align 4, !dbg !62
<span class="add">+  call void @__tesla_instrumentation_callee_return_hold(%struct.object* %o)</span>
   ret void, !dbg !63
 }
</code>

<p>
These language-level events are translated by machine-generated instrumentation
into symbols that can be consumed by TESLA automata:
</p>

<code class="listing"><span class="keywordflow">define</span> <span class="keyword">void</span> @__tesla_instrumentation_callee_enter_hold(%struct.object*) {
<span class="keywordflow">preamble</span>:
  %1 = <span class="keywordflow">call</span> <span class="keyword">i32</span> (...)* @tesla_debugging([13 x i8]* @debug_name)
  %2 = <span class="keywordflow">icmp</span> ne <span class="keyword">i32</span> %1, 0
  <span class="keywordflow">br</span> i1 %2, <span class="keyword">label</span> %printf, <span class="keyword">label</span> %entry

<span class="keywordflow">printf</span>:                                           <span class="comment">; preds = %preamble</span>
  %3 = <span class="keywordflow">call</span> <span class="keyword">i32</span> (<span class="keyword">i8*</span>, ...)* @printf(<span class="keyword">i8*</span> <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> ([20 x i8]* @8, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 0), %struct
.object* %0)
  <span class="keywordflow">br</span> <span class="keyword">label</span> %entry

<span class="keywordflow">entry</span>:                                            <span class="comment">; preds = %printf, %preamble</span>
  <span class="keywordflow">br</span> <span class="keyword">label</span> %"example.c:51#2:instr"

<span class="literal">"example.c:51#2:instr"</span>:                           <span class="comment">; preds = %entry</span>
  %key = <span class="keywordflow">alloca</span> %tesla_key+  %4 = <span class="keywordflow">ptrtoint</span> %struct.object* %0 to i64+
  %5 = <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> %tesla_key* %key, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 0+  store <span class="keyword">i64</span> %4, i64* %5+
  %6 = <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> %tesla_key* %key, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 4+  store <span class="keyword">i32</span> 1, i32* %6+
  %7 = <span class="keywordflow">call</span> <span class="keyword">i32</span> @tesla_update_state(<span class="keyword">i32</span> 1, <span class="keyword">i32</span> 6, %tesla_key* %key, <span class="keyword">i8*</span> <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> ([15 x i8]* @10, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 0), <span class="keyword">i8*</span> <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> ([328 x i8]* @11, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 0), %tesla_transitions* @transitions4)
  %8 = <span class="keywordflow">icmp</span> eq <span class="keyword">i32</span> %7, 0
  <span class="keywordflow">br</span> i1 %8, <span class="keyword">label</span> %"example.c:85#8:instr", <span class="keyword">label</span> %die

<span class="literal">"example.c:85#8:instr"</span>:                           <span class="comment">; preds = %"example.c:51#2:instr"</span>
  %key1 = <span class="keywordflow">alloca</span> %tesla_key
  %9 = <span class="keywordflow">ptrtoint</span> %struct.object* %0 to i64
  %10 = <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> %tesla_key* %key1, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 0
  store <span class="keyword">i64</span> %9, i64* %10
  %11 = <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> %tesla_key* %key1, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 4
  store <span class="keyword">i32</span> 1, i32* %11
  %12 = <span class="keywordflow">call</span> <span class="keyword">i32</span> @tesla_update_state(<span class="keyword">i32</span> 1, <span class="keyword">i32</span> 12, %tesla_key* %key1, <span class="keyword">i8*</span> <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> ([1
5 x i8]* @42, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 0), <span class="keyword">i8*</span> <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> ([684 x i8]* @43, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 0), %tesla_transi
tions* @transitions24)
  %13 = <span class="keywordflow">icmp</span> eq <span class="keyword">i32</span> %12, 0
  <span class="keywordflow">br</span> i1 %13, <span class="keyword">label</span> %exit, <span class="keyword">label</span> %die

<span class="keywordflow">exit</span>:                                             <span class="comment">; preds = %"example.c:85#8:instr"</span>
  ret <span class="keyword">void</span>

<span class="keywordflow">die</span>:                                              <span class="comment">; preds = %"example.c:85#8:instr", %"example.c:51#2</span>
:instr"
  <span class="keywordflow">call</span> <span class="keyword">void</span> @tesla_die(<span class="keyword">i8*</span> <span class="keywordflow">getelementptr</span> <span class="keyword">inbounds</span> ([42 x i8]* @9, <span class="keyword">i32</span> 0, <span class="keyword">i32</span> 0))
  ret <span class="keyword">void</span>
}
</code>

<p>
These instrumentated .ll files can be linked together into the final binary
(or shared library) using Clang.
The result must be linked against libtesla, which provides the
<code>tesla_update_state()</code> function.
</p>
</div></div><ul id="site-info"><li class="copy">&#169; 2013-2016 Jonathan Anderson<br />Information provided by <a href="/~jra40/">Jonathan Anderson</a></li></ul></div>
</body></html>